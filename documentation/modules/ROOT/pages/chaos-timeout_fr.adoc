:markup-in-source: verbatim,attributes,quotes
:CHE_URL: http://codeready-workspaces.%APPS_HOSTNAME_SUFFIX%
:USER_ID: %USER_ID%
:OPENSHIFT_PASSWORD: %OPENSHIFT_PASSWORD%
:OPENSHIFT_CONSOLE_URL: https://console-openshift-console.%APPS_HOSTNAME_SUFFIX%/topology/ns/chaos-engineering{USER_ID}/graph
:APPS_HOSTNAME_SUFFIX: %APPS_HOSTNAME_SUFFIX%
:KIALI_URL: https://kiali-istio-system.%APPS_HOSTNAME_SUFFIX%
:GRAFANA_URL: https://grafana-istio-system.%APPS_HOSTNAME_SUFFIX%

= Expérience Chaos 1: Injecting Timeout

_XX MINUTE PRACTICE_

== TODO

Pour minimiser l'impact de la latence, vous pouvez utiliser le modèle **timeout** qui est probablement le modèle de résilience le plus courant pour les systèmes distribués.
L'objectif est d'échouer une demande après une certaine période de temps pour éviter le verrouillage de code et de ressources lorsque le service attend une réponse qui prend trop de temps ou qui pourrait ne jamais arriver.

Dans le {KIALI_URL}[Kiali Console^], de la vue **'Services**, `*click on the 'travels' > 'Actions' > 'Request Timeouts'*`

image::kiali-request-timeout-actions.png[Kiali - Request Timeout Actions,900]

`*Add HTTP Timeout by entering the following settings:*`

. Réglages de timeout HTTP
[%header,cols=3*]
|MISUMI
|Paramètre
|Value
|MISUMI

|Add HTTP Timeout
|MISUMI
|MISUMI|

|Timeout
|**50ms**
|MISUMI|

|MISUMI

image::kiali-configure-timeout.png[Kiali - Configure Timeout,400]

Dans {GRAFANA_URL}[Grafana^], à partir du tableau de bord **, `*scroll down and see the latency metrics*`

Après un certain temps, vous pouvez voir l'impact de notre configuration. En effet, la latence du service **Voyages** a diminué et
les métriques de latence deviennent vertes à nouveau.

image::grafana-timeout-details-1.png[Grafana - Timeout Details,900]

image::grafana-timeout-details-2.png[Grafana - Timeout Details,900]

Les problèmes de latence ont été corrigés mais le calendrier introduit des erreurs pour les demandes qui dépassent le seuil.
`*Scroll up and see the error rate metrics*`

image::grafana-timeout-error.png[Grafana - Timeout Error,900]

== TODO

Vous avez mis en œuvre des délais pour le service de voyages.
Mettons en œuvre une stratégie de retry pour atténuer ces erreurs transitoires.

Dans le {KIALI_URL}[Kiali Console^], de la vue **'Services**,
`*click on the 'travels' > 'Actions' > 'Request Timeouts' and add HTTP Retry by entering the following settings:*`

. Réglages de rentrée HTTP
[%header,cols=3*]
|MISUMI
|Paramètre
|Value
|MISUMI

|Add HTTP Retry
|MISUMI
|MISUMI|

|Attempts
|**3**
|MISUMI|

|Per Try Timeout
|**10ms**
|MISUMI|

|MISUMI

image::kiali-configure-retry.png[Kiali - Configure Retry,400]

`*Back to TTKN1352[Grafana^]*`, vous pouvez dire que le motif de rétry réduit les taux d'erreur sans impacter la latence.

.