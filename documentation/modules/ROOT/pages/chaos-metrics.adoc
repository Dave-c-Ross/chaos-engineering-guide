:markup-in-source: verbatim,attributes,quotes
:CHE_URL: http://codeready-workspaces.%APPS_HOSTNAME_SUFFIX%
:USER_ID: %USER_ID%
:OPENSHIFT_PASSWORD: %OPENSHIFT_PASSWORD%
:KIALI_URL: https://kiali-istio-system.%APPS_HOSTNAME_SUFFIX%
:GRAFANA_URL: https://grafana-istio-system.%APPS_HOSTNAME_SUFFIX%
:COOLSTORE_HOMEPAGE: http://web-chaos-engineering{USER_ID}.%APPS_HOSTNAME_SUFFIX%
:DASHBOARD_GIT_URL: https://raw.githubusercontent.com/mcouliba/chaos-engineering-workshop/%WORKSHOP_GIT_REF%/grafana/chaos-engineering-dashboard.json

= Define and monitor Chaos metrics

_XX MINUTE PRACTICE_

As described in the **Chaos Engineering process** we are currently in a **Steady-state hypothesis**. It means we have to set **METRICS** to indicate that the system is working in an expected way from a business perspective, and within a given set of tolerances.


**Steady state** means that you can measure that the system is working in an expected way. In this case, that normal behavior is that the system will meet its **SLOs** ( **S**ervice **L**evel **O**bjective). 

Instead of asking the question: is the service up or down?
We ask the question: how many requests are we successfully serving?

Service Level Indicator (**SLI**):

A set of agreed upon observable and measurable characteristics that determine whether a request is successful.

For example:

* HTTP Code not equal 5xx
* Latency lower than X

Service Level Objective (**SLO**):

A target ratio of successful requests over the total number of requests (Different from the more traditional available time/servicing time).

For example: 

99.99% of the requests will be successful. 


== Monitoring with Service Mesh Grafana

Creating a simple **METRIC**

`*Click on the 'Developer Monitoring' button below*`.

[link={GRAFANA_URL}]
[window=_blank, align="center"]
[role='params-link']
image::developer-monitoring-button.png[Developer Monitoring - Button, 300]

Then, `*log in with OpenShift as 'user{USER_ID}/{OPENSHIFT_PASSWORD}'*`

image::grafana-home.png[Grafana - Home,900]

Now, let's create a dashboard to monitor the Chaos Metrics.

`*Click on  'plus (+) sign' > 'Create Dashboard' in the left hand side menu*`

image::grafana-create-dashboard.png[Grafana - Home,200]

Let's create the first **metric which defines the number of total requests in your namespace**.

`*Click on the 'Add Query'*`

image::grafana-panel-actions.png[Grafana - Home,500]

You are going to define the metric using a query language called **PromQL** (Prometheus Query Language).
This language will let you select and aggregate time series data in real time.

You will use the following incremental approach to understand and translate the first metric to PromQL expressions.

`*Enter the following expression into the 'Metrics' field for the Query 'A'*`:

image::grafana-add-query.png[Grafana - Home,700]

.Query Settings
[%header,cols=3*]
|===
|Step
|PromQL
|Description

|Step 1
a|**_istio_requests_total_**
|This is an https://istio.io/latest/docs/reference/config/metrics/[Istio standard metric^] exported to Prometheus by default.
It is a Counter measuring the total number of requests that have come through the Entire Service Mesh. This metric has several 
dimensions, per time series in a range vector

|Step 2
|**_istio_requests_total**{reporter="source", namespace="chaos-engineering{USER_ID}"}_
|Filter the metric to use only the inbound requests (_reporter="source"_) from your environment (_namespace="chaos-engineering{USER_ID}"_)  

|Step 3
|_increase(**istio_requests_total{reporter="source", namespace="chaos-engineering{USER_ID}**"}[1m])_
|Adding increase(), the query returns the only number of requests as measured over the last minute per time series.

|Step 4
|_sum(**increase(istio_requests_total{reporter="source", namespace="chaos-engineering{USER_ID}**"}[1m]))_
|Adding sum(), the query returns the total of requests within the namespace

|===

As result, you should be a time graph similar to the following one:

image::grafana-number-total-graph.png[Grafana - Home,700]

Then, `*click on 'Visualization Settings' icon on the left hand sidebar and enter the following parameters:*`

.Singlestat Settings
[%header,cols=3*]
|===
|Parameter
|Value
|Description

|Visualization 
|**Singlestat**
|

|Unit 
|**Throughput ops/min (opm)**
|

|Spark Lines
|**Show** enabled
|

|===

image::grafana-visualization-settings.png[Grafana - Home,500]

Finally, `*click on the 'General Settings' icon and enter the following parameters:*`

.General Settings
[%header,cols=3*]
|===
|Parameter
|Value
|Description

|Title 
|**Global Request Volume**
|

|===

image::grafana-general-settings.png[Grafana - Home,500]

**Congratulations!!!** You just created your first Chaos Metrics in a Grafana dashboard!

image::grafana-number-total-singlestat.png[Grafana - Home,400]     

Optional : 
After creating the METRIC of all requests we can define a METRIC of all SUCCESSFUL REQUESTS (~ error code 5XX) :

 Total Requests: sum(increase(istio_requests_total{}[$time_interval]))

 Successful requests: sum(increase(istio_requests_total{response_code!~"5.*"}[$time_interval])) 
 in our case :

_sum(increase(istio_requests_total{reporter="source", namespace="chaos-engineering{USER_ID}", response_code!~"5.*"}[1m]))_

== Import the Chaos Engineering Dashboard

You just learnt how to create a Grafana Dashboard. Now, let's import the full Grafana Dashboard needed to the chaos experiments.

`*Click on the following link, {DASHBOARD_GIT_URL}[Chaos Engineering Dashboard^] and copy the content*`

In {GRAFANA_URL}[Grafana^], `*Click on  'plus (+) sign' > 'Import Dashboard' in the left hand side menu*`

image::grafana-import-dashboard.png[Grafana - Home,200]

Then, `*paste the JSON content and click on 'Load' > 'Import'*`

image::grafana-load-dashboard.png[Grafana - Home,700]

If you are receiving an error mentioning ** A dashboard in this folder with the same name already exists**  add  'user{USER_ID}'in the Name 

image::error-import-grafana.png[Grafana import Error - Home,900]

You have now access the Chaos Engineering Dashboard.

image::grafana-chaos-engineering-dashboard.png[Grafana - Home,500]

== Explore the Chaos Engineering Dashboard

TODO