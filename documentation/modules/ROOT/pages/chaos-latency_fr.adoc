:markup-in-source: verbatim,attributes,quotes
:CHE_URL: http://codeready-workspaces.%APPS_HOSTNAME_SUFFIX%
:USER_ID: %USER_ID%
:OPENSHIFT_PASSWORD: %OPENSHIFT_PASSWORD%
:OPENSHIFT_CONSOLE_URL: https://console-openshift-console.%APPS_HOSTNAME_SUFFIX%/topology/ns/chaos-engineering{USER_ID}/graph
:APPS_HOSTNAME_SUFFIX: %APPS_HOSTNAME_SUFFIX%
:KIALI_URL: https://kiali-istio-system.%APPS_HOSTNAME_SUFFIX%
:GRAFANA_URL: https://grafana-istio-system.%APPS_HOSTNAME_SUFFIX%
:GITOPS_URL: https://argocd-server-argocd.%APPS_HOSTNAME_SUFFIX%

= Expérience Chaos 1: Latence du réseau

_30 MINUTE PRACTICE_

En production, il est plus fréquent d'avoir des services lents que des services rompus. **Latence** mesure le retard entre une action et une réponse. Pour cette première expérience, nous allons tester l'hypothèse suivante:

_**Une petite latence de réseau ne devrait pas affecter l'objectif de niveau de service (SLO) du Service de voyage**_

== Définir l'état stable


Dans le {GRAFANA_URL}[Chaos Engineering Dashboard, role='params-link'], vous pouvez analyser les différentes métriques et définir l'État Steady pour notre expérience de chaos.
Premièrement, `*select the following variables on the dashboard*`:

. Paramètres de tableau de bord
[%header,cols=3*]
|===
|Paramètre
| Valeur
|Description

| Namespace
|**chaos-engineering{USER_ID}**
|

|Service
|**travels.chaos-engineering{USER_ID}.svc.cluster.local**
|

|===

image::grafana-chaos-selection.png[Grafana - Chaos Selection,400]

De la section **Namespace**, vous pouvez dire que **99% des demandes sont réussies et servies dans les 50 ms**

image::grafana-steady-state-latency.png[Grafana - Steady State Latency,900]

Donc nous allons définir cette SLO comme "état ferme".

`*Click on 'Service Overview' > Edit*`

image::grafana-edit-service-overview.png[Grafana - Edit Service Overview,900]

Puis, `*click on 'Visualization Settings' icon on the left hand sidebar, scroll down to find the 'P99 Latency (Value #D)' rule and enter the following information for Thresholds*`

Réglages des seuils de latence P99
[%header,cols=3*]
|===
|Paramètre
|Value
|Description

|
|**50,100**
|

|Color Mode
|**Cell**
|

|Colors
|**Green/Yellow/Red** (cliquez sur le bouton 'invert' si nécessaire)
|

|===

image::grafana-p99-latency-threholds.png[Grafana - P99 Latency Threholds,700]

`*Scroll down again and to find the 'Success Rate (Value #E)' rule and enter the following information for Thresholds*`

. Success Rate Thresholds Paramètres
[%header,cols=3*]
|===
|Paramètre
|Value
|Description

|Seuils
|**0.95,0.99**
|

|Color Mode
|**Cell**
|

|Colors
|**Red/Yellow/Green** (cliquez sur le bouton 'invert' si nécessaire)
|

|===

image::grafana-success-rate-threholds.png[Grafana - Sucess Rate Threholds,700]

Une fois terminé, vous devriez avoir le résultat suivant (tout vert).

image::grafana-service-overview-configured.png[Grafana - Service Overview Configured,700]

`*Click on the 'Disk' icon to save and go back to the Dashboard.*`

== Exécutez l'expérience Chaos

Dans le {KIALI_URL}[Kiali Console^, role='params-link'], de la vue **'Graph'**, `*right-click on the 'discounts' service (triangle symbol) and select 'Details'*`

image::kiali-right-click-service.png[Kiali - Right Click Service,600]

Vous serez redirigé vers la page Détails du service.

`*Click on the 'Actions' > 'Fault Injection'*`

image::kiali-add-fault-injection.png[Kiali - Add Fault Injection,900]

`*Add HTTP Delay by entering the following settings:*`

. Paramètres de retard HTTP
[%header,cols=3*]
|===
|Paramètre
|Value
|Description

|Add HTTP Delay
|**Enabled**
|

| Pourcentage de retard
|**5**
|

|Fixed Reporté
|**1s**
|

|===

image::kiali-configure-latency.png[Kiali - Configure Latency,400]

`*Click on the 'Update' button*`.

**5% du trafic du service des « comptes » a maintenant 1 seconde de retard. **

== Analyser le résultat Chaos

Voyons maintenant l'impact de l'application.

Dans le {GRAFANA_URL}[Chaos Engineering Dashboard], vous pouvez voir le résultat de l'expérience de chaos.

image::grafana-latency-fault-overview.png[Grafana - Latency Fault Overview,900]

Depuis le panel **'Service Aperçu'** ou **'Request Durée'** pour le service 'voyages', vous pouvez dire ce qui suit sur la petite latence réseau basée sur notre hypothèse:

- il n'y a pas d'impact sur le taux de réussite des demandes globales (100%)
- il y a un impact énorme sur la performance de l'application.

En effet, seulement 1 seconde de retard sur 5% du trafic d'un service à charge induit **une propagation de latence de ~2 secondes dans l'ensemble du système**.

image::grafana-latency-fault-details.png[Grafana - Latency Fault Details,900]

En conclusion, vous pouvez dire **l'application n'est pas résiliente à une petite latence réseau**. Pour réduire ou réparer ce phénomène, vous pouvez configurer l'autoscaling ou mettre en place un mécanisme de cache dans les différents services des applications.

== Améliorer la résilience

Pour contenir cette propagation de latence, vous allez appliquer le modèle *Retry* à tous les services appelant les services différés.

Les entrées peuvent améliorer la résilience de l'application contre des problèmes transscientifiques comme un service ou un réseau temporairement surchargé comme nous simulons dans notre expérience.

Au lieu de manquer directement ou d'attendre trop longtemps, nous pourrions réessayer N nombre de fois pour obtenir la sortie souhaitée avec le temps de réponse souhaité avant de considérer comme échoué.

`*Configure the Retry pattern for the following services*`

[tabs]
====
cars::
+
--
Dans le {KIALI_URL}[Kiali Console^, role='params-link'], de la vue **'Services**, `*click on the 'cars' service > 'Actions' > 'Request Timeouts'*`

`*Add HTTP Retry by entering the following settings:*`

. Réglages de rentrée HTTP
[%header,cols=3*]
|===
|Paramètre
|Value
|Description

|Add HTTP Retry
|**Enabled**
|

|Attempts
|**5**
|

|P Essayez le timeout
|**20ms**
|

|===

image::kiali-configure-latency-retry.png[Kiali - Configure Latency Retry,400]

`*Click on the 'Update' button*`.
--

flights::
+
--
Dans le {KIALI_URL}[Kiali Console^, role='params-link'], de la vue **'Services**, `*click on the 'flights' service > 'Actions' > 'Request Timeouts'*`

`*Add HTTP Retry by entering the following settings:*`

. Réglages de rentrée HTTP
[%header,cols=3*]
|===
|Paramètre
| Valeur
|Description

|Add HTTP Retry
|**Enabled**
|

|Attempts
|**5**
|

| Per Essayez le timeout
|**20ms**
|

|===

image::kiali-configure-latency-retry.png[Kiali - Configure Latency Retry,400]

`*Click on the 'Update' button*`.
--

hotels::
+
--
Dans le {KIALI_URL}[Kiali Console^, role='params-link'], de la vue **'Services**, `*click on the 'hotels' service > 'Actions' > 'Request Timeouts'*`

`*Add HTTP Retry by entering the following settings:*`

. Réglages de rentrée HTTP
[%header,cols=3*]
|===
|Paramètre
|Value
|Description

|Add HTTP Retry
|**Enabled**
|

|Attempts
|**5**
|

|per Essayez le timeout
|**20ms**
|

|===

image::kiali-configure-latency-retry.png[Kiali - Configure Latency Retry,400]

`*Click on the 'Update' button*`.
--

insurances::
+
--
Dans le {KIALI_URL}[Kiali Console^, role='params-link'], de la vue **'Services**, `*click on the 'insurances' service > 'Actions' > 'Request Timeouts'*`

`*Add HTTP Retry by entering the following settings:*`

. Réglages de rentrée HTTP
[%header,cols=3*]
|===
|Paramètre
|Value
|Description

|Add HTTP Retry
|**Enabled**
|

|Attempts
|**5**
|

|Per Essayez le timeout
|**20ms**
|

|===

image::kiali-configure-latency-retry.png[Kiali - Configure Latency Retry,400]

`*Click on the 'Update' button*`.
--
====

== Valider l'amélioration

Retour dans le {GRAFANA_URL}[Chaos Engineering Dashboard], vous pouvez dire que nous parvenons à contenir la propagation de latence de **ne dépassant pas 100 ms en général** en utilisant le modèle Retry tandis que le service 'discounts' a toujours le problème de latence 1s.

image::grafana-latency-contained-overview.png[Grafana - Latency Contained Overview,900]

Vous pouvez voir plus de détails sur le panneau 'Request Durée' pour le service 'voyages'

image::grafana-latency-contained-details.png[Grafana - Latency Contained Details,900]

== Retourner l'expérience Chaos

Il n'y a rien de plus simple que de retourner toutes les configurations que vous avez faites pendant ce laboratoire avec Argo CD.

Dans {GITOPS_URL}[Argo CD^, role='params-link'], `*click on 'Sync > Synchronize'*`.

image::argocd-rollback-sync.png[Argo CD - Sync Application, 900]

Enfin, dans le {GRAFANA_URL}[Chaos Engineering Dashboard], `*please check the application is back in the steady state*`.

image::grafana-steady-state.png[Grafana - Steady State,700]