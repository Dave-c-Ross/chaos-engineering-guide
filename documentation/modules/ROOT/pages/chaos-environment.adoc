:markup-in-source: verbatim,attributes,quotes
:navtitle: Get your Chaos environment
:CHE_URL: http://codeready-workspaces.%APPS_HOSTNAME_SUFFIX%
:USER_ID: %USER_ID%
:OPENSHIFT_PASSWORD: %OPENSHIFT_PASSWORD%
:OPENSHIFT_CONSOLE_URL: https://console-openshift-console.%APPS_HOSTNAME_SUFFIX%/topology/ns/chaos-engineering{USER_ID}/graph
:GITOPS_URL: https://argocd-server-argocd.%APPS_HOSTNAME_SUFFIX%
:KIALI_URL: https://kiali-istio-system.%APPS_HOSTNAME_SUFFIX%
:GITOPS_WORKSHOP_GIT_URL: %WORKSHOP_GIT_REPO%/tree/%WORKSHOP_GIT_REF%/gitops

= Get your Chaos environment

_XX MINUTE EXERCISE_

In this section, you will explore OpenShift and deploy the application we would like to evaluate.

== What is Red Hat OpenShift?


[sidebar]
--
**Red Hat® OpenShift®** enables enterprises to build highly agile, scalable architectures with enhanced cluster security that can be deployed at any location.

**Red Hat® OpenShift®** offers automated installation, upgrades, and lifecycle management throughout the container stack—the operating system, https://www.openshift.com/learn/topics/kubernetes/?hsLang=en-us[Kubernetes] and cluster services, and applications—on any cloud.
--

== Log in to the OpenShift Web Console

OpenShift ships with a web-based console that will allow users to
perform various tasks via a browser.

`*Click on the 'Developer Console' button below*`

[link={OPENSHIFT_CONSOLE_URL}]
[window="_blank"]
[role='params-link']
image::developer-console-button.png[Developer Workspace - Button, 300]

`*Enter your username and password (user{USER_ID}/{OPENSHIFT_PASSWORD})*` and 
then log in. After you have authenticated to the web console, you will be presented with a
list of projects that your user has permission to work with. 

`*Select the 'Developer View' then your 'chaos-engineering{USER_ID}'*` to be taken to the project overview page
which will list all of the routes, services, deployments, and pods that you have
running as part of your project. There's nothing there now, but that's about to
change.

image::openshift-empty-project.png[OpenShift - Empty Project, 700]

== What is OpenShift GitOps?

[sidebar]
--
**OpenShift GitOps** is a service available on top of OpenShift. 

**OpenShift GitOps** is an OpenShift add-on which provides Argo CD and other tooling to enable teams to implement GitOps workflows for cluster configuration and application delivery. 

**OpenShift GitOps** is available as an operator in the OperatorHub and can be installed with  a simple one-click experience. Once installed, users can deploy Argo CD instances using Kubernetes custom resources.

--

image::gitops-model.png[gitops-model - Button, 800]

**Argo CD** features

* Cluster and application configuration versioned in Git
* Automatically syncs configuration from Git to clusters
* Drift detection, visualization and correction
* Granular control over sync order for complex rollouts
* Rollback and rollforward to any Git commit
* Manifest templating support (Helm, Kustomize, etc)
* Visual insight into sync status and history

image::argocd-features.png[argo features- Button, 400]

**Argo CD** mechanism

image::Gitops-Openshift.png[Gitops - Button, 900]




== Log in to OpenShift GitOps (Argo CD)

`*Click on the 'Developer GitOps' button below*`

[link={GITOPS_URL}]
[role='params-link']
[window="_blank"]
image::developer-gitops-button.png[Developer GitOps - Button, 300]

Then `*log in as user{USER_ID}/{OPENSHIFT_PASSWORD}*`. Once completed, you will be redirected to the following page which lists the **Argo CD Applications**.

image::argocd-home.png[Argo CD - Home Page, 500]

An **Argo CD Application** is the Kubernetes resource object representing a deployed application instance in an environment. It is defined by two key pieces of information:

* **source** reference to the desired state in Git (repository, revision, path, environment): **{GITOPS_WORKSHOP_GIT_URL}**
* **destination** reference to the target cluster and namespace: **'chaos-engineering{USER_ID}' namespace from the current OpenShift cluster (in-cluster)**

The **Argo CD Application** status is initially in yellow, means **OutOfSync** state, since the application has yet to be 
deployed into **'chaos-engineering{USER_ID}'** namespace, and no Kubernetes resources have been created.

== Sync/Deploy the application


To deploy the application, 
`*click on your 'chaos-engineering{USER_ID}' application box then, click on 'Sync > Synchronize'*`.

image::argocd-sync.png[Argo CD - Sync Application, 900]

This task retrieves the manifests from the Git Repository and performs _kubectl apply_ command of 
the manifests. Your application is now running. You can now view its resource components,
logs, events, and assessed health status.

After a couple of seconds, you should see everything in green.

image::argocd-synced-application.png[Argo CD - Synced Application, 800]

In the link:{OPENSHIFT_CONSOLE_URL}[OpenShift Web Console^, role='params-link'], from the **Developer view**,
select the `**chaos-engineering{USER_ID}**` to be taken to the project overview page.

image::openshift-app-deployed-by-argocd.png[OpenShift - Coolstore Project Deployed by Argo CD , 700]

You can see that all resources of your application have been created by Argo CD. 

Now you are ready to get started with the labs!

== Application description

Before to continue we will describe the application used in this workshop.

This demo application will deploy several services grouped into three namespaces.

* **'travel-agency{USER_ID}'** namespace
* **'travel-portal{USER_ID}'** namespace
* **'travel-control{USER_ID}'** namespace

**Travel Portal namespace**

The Travels Demo application simulates two business domains organized in different namespaces.

In a first namespace called **'travel-portal{USER_ID}'** there will be deployed several travel shops, where users can search for and book flights, hotels, cars or insurance.

The shop applications can behave differently based on request characteristics like channel (web or mobile) or user (new or existing).

These workloads may generate different types of traffic to imitate different real scenarios.

All the portals consume a service called travels deployed in the **'travel-agency{USER_ID}'** namespace.

**Travel Agency namespace**

A second namespace called **'travel-agency{USER_ID}'** will host a set of services created to provide quotes for travel.

A main travels service will be the business entry point for the travel agency. It receives a destination city and a user as parameters and it calculates all elements that compose a travel budget: airfare, lodging, car reservation and travel insurance.

Each service can provide an independent quote and the travels service must then aggregate them into a single response.

Additionally, some users, like registered users, can have access to special discounts, managed as well by an external service.

Service relations between namespaces can be described in the following diagram:

image::travels-demo-design.png[travel-demo-design - Travel demo Project deployed by Argo CD , 800]

**Travel Portal and Travel Agency flow**

A typical flow consists of the following steps:

<.> A portal queries the travels service for available destinations.

<.> Travels service queries the available hotels and returns to the portal shop.

<.> A user selects a destination and a type of travel, which may include a flight and/or a car, hotel and insurance.

<.> Cars, Hotels and Flights may have available discounts depending on user type.

**Travel Control namespace**

The **'travel-control{USER_ID}'** namespace runs a **business dashboard** with two key features:

* Allow setting changes for every travel shop simulator (traffic ratio, device, user and type of travel).

* Provide a **business** view of the total requests generated from the **'travel-control{USER_ID}'** namespace to the **travel-agency** services, organized by business criteria as grouped per shop, per type of traffic and per city.

image::travels-dashboard.png[travels-dashboard - Business Dashboard , 800]